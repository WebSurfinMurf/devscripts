#!/bin/bash
# Enhanced startclaude script with context bootstrapping
# Usage: 
#   startclaude           - Start Claude Code with context
#   startclaude --shell   - Enter container shell
#   startclaude --status  - Show container status
#   startclaude --resume  - Resume previous conversation

# Color codes
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

case "${1:-}" in
    --shell|-s)
        echo "ðŸš Entering Claude Code container shell..."
        docker exec -it claude-code bash
        ;;
    --status|--info|-i)
        echo "ðŸ“Š Claude Code Status:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAMES|claude-code"
        echo ""
        echo "ðŸ’¾ Container size:"
        docker system df | grep -E "REPOSITORY|claude-code"
        ;;
    --resume|-r)
        echo "ðŸ“‚ Resuming previous conversation..."
        docker exec -it claude-code claude --resume
        ;;
    --help|-h)
        echo "ðŸ¤– Claude Code Launcher"
        echo ""
        echo "Usage:"
        echo "  startclaude           Start Claude Code CLI with context"
        echo "  startclaude --shell   Enter container shell"
        echo "  startclaude --status  Show container status"
        echo "  startclaude --resume  Resume previous conversation"
        echo "  startclaude --help    Show this help"
        echo ""
        echo "Context files:"
        echo "  /home/claude/workspace/AINotes/AINotes.md - Main environment documentation"
        echo "  */CLAUDE.md - Project-specific notes in each directory"
        ;;
    *)
        # Default: start Claude with context bootstrap
        if ! docker ps --format '{{.Names}}' | grep -q '^claude-code$'; then
            echo "âŒ claude-code container is not running"
            echo "ðŸ’¡ Start it with: cd /home/websurfinmurf/projects/claude-code && ./deploy.sh"
            exit 1
        fi
        
        echo -e "${BLUE}ðŸš€ Starting Claude Code with context...${NC}"
        echo ""
        
        # Create a context prompt file that Claude will read
        CONTEXT_PROMPT="Please read the following context files to understand the environment:

1. First, read /home/claude/workspace/AINotes/AINotes.md - this contains comprehensive environment documentation
2. Check for CLAUDE.md files in the current working directory and /home/claude/workspace/devscripts/CLAUDE.md
3. Check for recent session notes in /home/claude/workspace/AINotes/claude/ directory
4. Note the critical rules section in AINotes.md about workspace separation and no backup files in git

After reading these files, briefly confirm you've loaded the context by listing:
- The date of the last session from AINotes.md
- Any recent session notes from AINotes/claude/
- Any known issues from CLAUDE.md files
- The critical rules you must follow

Then wait for my next instruction."

        # Create the init message file
        docker exec claude-code bash -c "cat > /tmp/claude_init.txt << 'EOF'
$CONTEXT_PROMPT
EOF"
        
        echo -e "${GREEN}ðŸ“š Context prepared. Starting interactive session...${NC}"
        echo -e "${YELLOW}â†’ Auto-loading environment context...${NC}"
        echo ""
        
        # Start Claude interactively with the init message
        docker exec -it claude-code bash -c "cat /tmp/claude_init.txt && echo '' && exec claude"
        ;;
esac
